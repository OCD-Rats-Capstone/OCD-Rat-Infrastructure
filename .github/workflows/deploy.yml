name: Deploy RatBat2
permissions:
    contents: read
on: 
    push:
        branches: ["main"]
    workflow_dispatch: # allows for manual deployment of any branch

jobs:
    deploy: 
        runs-on: [self-hosted, Linux, X64]
        environment: Production
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
            - name: Deploy to RatBat2
              run: |
                # Navigate to shared directory 
                cd /home/RatBat2/OCD-Rat-Infrastructure
                git fetch origin
                git checkout ${{ github.ref_name }}
                git reset --hard origin/${{ github.ref_name }}
                
                # Create .env file from GitHub Secret
                echo "${{ secrets.PROD_ENV_FILE }}" > .env
                

                # Build and run docker containers
                if [ "${{ github.ref_name }}" == "main" ]; then
                  # Production: standard ports (80/443, 8000, 5433)
                  echo "Deploying PRODUCTION on ports 80/8000/5433..."
                  docker compose down
                  docker compose -f docker-compose.yml -f docker-compose.override.yml -p ocd-prod up -d --build
                else
                  # Staging: alternative ports (8080, 8001)
                  echo "Deploying STAGING on ports 8080/8001..."
                  docker compose down
                  docker compose -f docker-compose.yml -f docker-compose.dev.yml -p ocd-staging up -d --build
                fi
              
              
